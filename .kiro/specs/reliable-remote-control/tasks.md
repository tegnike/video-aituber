# Implementation Plan

## Tasks

- [x] 1. コマンドキュー機能の実装
- [x] 1.1 コマンドキューのデータ構造と操作関数を追加
  - インメモリ配列でコマンドを保持するキュー機構を実装
  - エンキュー関数（コマンド追加）を作成
  - デキュー関数（全コマンド取得+削除）を作成
  - 最大100件の制限を設け、超過時は古いコマンドから削除
  - FIFO順序を保証する
  - _Requirements: 1.3, 1.4, 2.1, 2.3, 2.4_

- [x] 1.2 コマンド送信時にキューへ追加する処理を実装
  - 既存のコマンド送信エンドポイントを修正
  - コマンド受信時にキューへエンキューする
  - SSEブロードキャスト処理を削除
  - _Requirements: 2.1_

- [x] 1.3 コマンド取得用APIエンドポイントを新規作成
  - GETリクエストでキュー内の全コマンドを返却
  - 返却と同時にキューをクリア（アトミックに処理）
  - 空の場合は空配列を返却
  - _Requirements: 1.1, 1.4, 2.2, 2.3_

- [x] 2. リモートパネル用ポーリングフックの実装
- [x] 2.1 (P) SSEからポーリング方式に切り替え
  - 既存のuseRemoteSyncフックをポーリング方式に書き換え
  - 500ms間隔で状態取得APIをポーリング
  - EventSourceの使用を削除
  - _Requirements: 3.2, 3.4_

- [x] 2.2 エラーハンドリングと再試行機能を実装
  - ポーリング失敗時は次の間隔で自動再試行
  - コマンド送信失敗時は自動再送信
  - エラー時もUIをブロックせず、状態表示で通知
  - 接続回復時は通常動作に復帰
  - _Requirements: 3.3, 4.1, 4.3, 4.4_

- [x] 3. メイン画面用ポーリングフックの実装
- [x] 3.1 (P) コマンドポーリング機能を実装
  - 既存のuseMainScreenSyncフックをポーリング方式に書き換え
  - 500ms間隔でコマンド取得APIをポーリング
  - 取得したコマンドをFIFO順序で実行
  - EventSourceの使用を削除
  - _Requirements: 1.1, 1.2, 2.2_

- [x] 3.2 状態報告とエラーハンドリングを実装
  - 状態変更時にサーバーへ報告する機能を維持
  - ポーリング失敗時は次の間隔で自動再試行
  - エラー時もUIをブロックせず操作を継続可能に
  - 接続回復時は通常動作に復帰
  - _Requirements: 3.1, 4.2, 4.3, 4.4_

- [x] 4. SSEエンドポイントの削除と統合
- [x] 4.1 SSE関連コードのクリーンアップ
  - SSEエンドポイント（/api/remote/events）を削除
  - remoteState.tsからSSE関連の購読機能を削除
  - 不要になったbroadcastCommand関数を削除
  - _Requirements: 1.1_

- [x] 4.2 既存機能の動作確認
  - 画面モード切り替え（standby/room）が動作することを確認
  - コントロールビデオ再生（start/end）が動作することを確認
  - わんコメ連携のON/OFF切り替えが動作することを確認
  - 台本送信機能が動作することを確認
  - UI表示切り替え（controls/chatHistory/chatInput）が動作することを確認
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 5. テストの実装
- [x] 5.1 (P) コマンドキューのユニットテスト
  - エンキュー/デキュー操作のテスト
  - FIFO順序保証のテスト
  - 上限100件制限のテスト
  - 空キュー時の動作テスト
  - _Requirements: 1.3, 1.4, 2.1, 2.3, 2.4_

- [x] 5.2 (P) ポーリングフックのユニットテスト
  - ポーリング開始/停止のテスト
  - エラーハンドリングのテスト
  - コマンド実行順序のテスト
  - _Requirements: 1.1, 1.2, 3.2, 3.4, 4.1, 4.2, 4.3_

- [x] 5.3 統合テスト
  - コマンド送信→キュー追加→取得→実行の一連フローをテスト
  - 複数コマンドの順序保証をテスト
  - エラー発生時の復旧動作をテスト
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4, 4.4_
