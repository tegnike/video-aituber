# Implementation Plan

## Tasks

- [x] 1. 状態管理層の拡張
- [x] 1.1 コメントキュー用の型定義を追加
  - キューイングされたコメントを表すデータ構造を定義
  - ユーザー名、コメント内容、プロフィール画像、受信時刻、送信状態を含む
  - コメントIDはわんコメから取得したIDを使用
  - _Requirements: 1.2, 2.3_

- [x] 1.2 AppStateにコメントキューフィールドを追加
  - アプリケーション状態にコメントキュー配列を追加
  - 初期値は空配列
  - SSE経由でリモートパネルに同期される
  - _Requirements: 1.1, 1.3_

- [x] 1.3 (P) 送信コマンドの型定義を追加
  - コメントIDを指定して送信を指示するコマンド型を定義
  - 既存のRemoteCommand型を拡張
  - _Requirements: 3.1, 3.3_

- [x] 2. メイン画面のコメント処理変更
- [x] 2.1 わんコメコメント受信時の処理を変更
  - コメント受信時にLLMへの自動送信を停止
  - 受信したコメントをキューに追加（新しいものが先頭）
  - メイン画面のチャット履歴には従来通り表示
  - 送信状態は未送信として初期化
  - _Requirements: 1.1, 1.4, 2.1, 2.2, 2.3_

- [x] 2.2 送信コマンドのハンドラを追加
  - リモートパネルからの送信コマンドを受信
  - 指定されたコメントIDのコメントをLLMサーバーに送信
  - 送信完了後にキュー内のコメントを送信済みに更新
  - 既に送信済みのコメントは無視
  - _Requirements: 3.1, 3.3, 4.1_

- [x] 2.3 コメントキュー状態のリモート同期
  - コメントキューの変更をリモートパネルに報告
  - 既存のSSE同期パターンを使用
  - キュー追加時と送信完了時に状態を更新
  - _Requirements: 1.1, 4.1_

- [x] 3. コントロールパネルUIの実装
- [x] 3.1 コメントキューパネルコンポーネントの作成
  - コメント一覧を表示するパネルUIを作成
  - 各コメントにユーザー名、内容、受信時刻を表示
  - パネル上部にコメント件数を表示
  - 新しいコメントが上部に表示されるようリスト順序を設定
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [x] 3.2 (P) 送信ボタンと送信済み表示の実装
  - 各コメント行に送信ボタンを配置
  - クリック時に確認なしで即座に送信コマンドを発行
  - 送信済みコメントは視覚的に区別（背景色、透明度など）
  - 送信済みコメントの送信ボタンは非活性化
  - _Requirements: 3.2, 3.3, 4.2, 4.3_

- [x] 3.3 リモートページへのパネル統合
  - 既存のグリッドレイアウトにコメントキューパネルを追加
  - useRemoteSyncから状態を取得しパネルに渡す
  - 送信コマンド発行のハンドラを接続
  - _Requirements: 1.1, 3.1_

- [x] 4. 統合テストと動作確認
- [x] 4.1 エンドツーエンドのフロー検証
  - わんコメからコメント受信→キュー追加の動作確認
  - リモートパネルでのキュー表示の確認
  - 送信ボタン→LLM送信→送信済み表示の確認
  - メイン画面のチャット履歴に送信状態が表示されないことの確認
  - _Requirements: 1.1, 2.1, 2.2, 3.1, 4.1, 5.1, 5.2_

## Requirements Coverage

| Requirement | Task(s) | Status |
|-------------|---------|--------|
| 1.1 | 1.2, 2.1, 2.3, 3.1, 3.3, 4.1 | Covered |
| 1.2 | 1.1, 3.1 | Covered |
| 1.3 | 1.2, 3.1 | Covered |
| 1.4 | 2.1, 3.1 | Covered |
| 2.1 | 2.1, 4.1 | Covered |
| 2.2 | 2.1, 4.1 | Covered |
| 2.3 | 1.1, 2.1 | Covered |
| 3.1 | 1.3, 2.2, 3.3, 4.1 | Covered |
| 3.2 | 3.2 | Covered |
| 3.3 | 1.3, 2.2, 3.2 | Covered |
| 4.1 | 2.2, 2.3, 4.1 | Covered |
| 4.2 | 3.2 | Covered |
| 4.3 | 3.2 | Covered |
| 5.1 | 4.1 | Covered |
| 5.2 | 4.1 | Covered |
