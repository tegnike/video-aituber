# Implementation Plan

## Tasks

- [x] 1. コールバックAPIのセッション対応
- [x] 1.1 セッション別動画キューのデータ構造を定義する
  - セッションIDをキーとした動画エントリのMap構造を作成
  - 各エントリにシーケンス番号、動画パス、タイムスタンプを保持
  - 次に期待するシーケンス番号と総動画数を管理
  - _Requirements: 2.1, 2.4_

- [x] 1.2 コールバックPOSTでセッション別キューに格納する
  - リクエストからsessionId、sequence、totalCountを取得
  - sessionIdがある場合はセッション別キューに格納
  - sessionIdがない場合は従来の動作を維持（後方互換性）
  - _Requirements: 2.1, 2.4_

- [x] 1.3 コールバックGETでシーケンス順に動画を返却する
  - クエリパラメータからsessionIdを取得
  - 次に期待するシーケンス番号の動画が存在すれば返却
  - 未到着の場合はnullを返却して待機を継続
  - 全動画取得完了時にisCompleteフラグを設定
  - _Requirements: 2.2, 2.3, 3.1, 3.2_

- [x] 1.4 古いセッションの自動クリーンアップを実装する
  - 1時間経過したセッションを自動削除
  - POSTとGETの両方で定期的にクリーンアップを実行
  - _Requirements: 3.3_

- [x] 2. フロントエンドのセッション管理とシーケンス番号付与
- [x] 2.1 (P) セッションID生成とシーケンス番号付与をfetchControlVideoに追加する
  - ボタンクリック時にUUIDでセッションIDを生成
  - アクション配列の各要素に0からのシーケンス番号を付与
  - afterActionsにはactions数からの連番を付与
  - 動画生成APIリクエストにsessionId、sequence、totalCountを含める
  - _Requirements: 1.3, 1.4, 2.4_

- [x] 2.2 セッションIDを使ったポーリングに変更する
  - 現在のセッションIDを状態として管理
  - ポーリング時にsessionIdをクエリパラメータとして送信
  - sessionIdがない場合は従来のポーリング動作を維持
  - _Requirements: 3.1, 3.2_

- [x] 2.3 ポーリング結果を順序通りにVideoPlayerに渡す
  - コールバックAPIから取得した動画を順序通りにキューに追加
  - isCompleteフラグでセッション完了を検知
  - セッション完了後に状態をクリア
  - _Requirements: 1.1, 1.2, 4.1, 4.3_

- [x] 3. VideoPlayerの順序維持確認と調整
- [x] 3.1 initialQueueの順序維持を確認する
  - 渡された配列の順序がそのまま再生順序になることを確認
  - pendingGeneratedVideosへの追加が順序を維持することを確認
  - 必要に応じてロジックを調整
  - _Requirements: 4.1, 4.2, 4.3_

- [x] 4. 統合テストと動作確認
- [x] 4.1 開始・終了ボタンの順序保証をテストする
  - 設定ファイルの順序通りに動画が再生されることを確認
  - actionsの後にafterActionsが再生されることを確認
  - 複数動画の順序が正しいことを確認
  - _Requirements: 1.1, 1.2, 1.4_

- [x] 4.2 後方互換性をテストする
  - sessionIdなしのリクエストが従来通り動作することを確認
  - 既存のチャット応答動画の動作に影響がないことを確認
  - _Requirements: 2.1, 3.1_
