# Implementation Plan

## Tasks

- [x] 1. 型定義とシーケンスパース機能の実装
- [x] 1.1 (P) シーケンスファイルの型定義を追加する
  - 自動送信の状態（idle/running/paused/completed）を表す型を定義する
  - シーケンスファイル形式（name, scripts, defaultInterval）の型を定義する
  - Hookの返却状態とアクションの型を定義する
  - 既存のScript型を再利用してシーケンス内台本の型整合性を確保する
  - _Requirements: 1.2_

- [x] 1.2 シーケンスファイルのパースとバリデーション機能を実装する
  - JSONファイルを読み込んでパースする関数を作成する
  - scriptsプロパティの存在と配列形式をチェックする
  - 既存のvalidateScript関数を再利用して各台本をバリデーションする
  - エラー発生時は具体的なエラーメッセージを返却する（位置情報含む）
  - defaultIntervalがあれば抽出、なければシステムデフォルトを適用する
  - _Requirements: 1.2, 1.3_

- [x] 2. 自動送信Hookのコア機能実装
- [x] 2.1 Hookの状態管理基盤を構築する
  - useStateで状態（status, sequence, currentIndex, interval, error）を管理する
  - デフォルト送信間隔を定数として定義する（5秒）
  - loadSequence関数でFile APIを使ってファイルを読み込みパースする
  - パース成功時はシーケンスを状態に保存、失敗時はエラーを設定する
  - clearSequence関数で状態をリセットする
  - _Requirements: 1.2, 1.3, 4.2_

- [x] 2.2 自動送信の開始・停止機能を実装する
  - start関数でstatusをrunningに変更し送信ループを開始する
  - stop関数でstatusをidleに戻しcurrentIndexを0にリセットする
  - 開始時はcurrentIndex=0から順番にonScriptSendを呼び出す
  - 各送信後はisSendingがfalseになるまで待機する
  - isSending待機後に設定された間隔（interval秒）を追加で待機する
  - 全台本送信完了後はstatusをcompletedに変更する
  - _Requirements: 2.1, 2.2, 2.4, 5.1, 5.2_

- [x] 2.3 一時停止と再開機能を実装する
  - pause関数でstatusをpausedに変更する
  - 一時停止時はタイマーをキャンセルし現在のインデックスを保持する
  - resume関数でstatusをrunningに戻し送信を再開する
  - 再開時は保持していたインデックスの次の台本から送信を継続する
  - statusがrunning以外の場合はpauseを無視する
  - _Requirements: 3.1, 3.2_

- [x] 2.4 送信間隔の動的変更機能を実装する
  - setInterval関数で送信間隔を変更する
  - 負の値が渡された場合は0に正規化する
  - 実行中の変更は次の送信サイクルから適用する
  - シーケンスファイルのdefaultIntervalがある場合は読み込み時に適用する
  - _Requirements: 4.3, 4.4_

- [x] 3. UIコンポーネントの実装
- [x] 3.1 (P) ファイル選択UIを実装する
  - input type="file"でJSONファイルを選択できるようにする
  - ファイル選択時にloadSequenceを呼び出す
  - 読み込み中はローディング表示を行う
  - エラー時はエラーメッセージを赤字で表示する
  - 既存ScriptPanelと同じ配色・角丸・背景スタイルを適用する
  - _Requirements: 1.1, 1.3, 5.3_

- [x] 3.2 シーケンスプレビューと進捗表示を実装する
  - 読み込み成功時はシーケンス名と台本件数を表示する
  - 現在送信中の台本インデックスと総数を「3/10」形式で表示する
  - 送信中の台本のlabelとtextをプレビュー表示する
  - 完了時は「完了しました」メッセージを表示する
  - _Requirements: 1.4, 2.3, 2.4_

- [x] 3.3 制御ボタン群を実装する
  - 開始ボタン：シーケンス読み込み済みかつidle時のみ有効
  - 一時停止ボタン：running時のみ表示
  - 再開ボタン：paused時のみ表示
  - 停止ボタン：runningまたはpaused時に表示
  - 各ボタンは対応するHookの関数を呼び出す
  - 送信中（isSending=true）は全ボタンを一時的に無効化する
  - _Requirements: 2.1, 3.1, 3.2, 3.3, 3.4_

- [x] 3.4 送信間隔設定UIを実装する
  - 数値入力フィールドで秒単位の間隔を設定する
  - 入力値変更時にsetIntervalを呼び出す
  - 現在の間隔値を表示する
  - idle/paused時のみ編集可能にするか、常時編集可能にするかを既存UIパターンに合わせる
  - _Requirements: 4.1_

- [x] 4. 親コンポーネントへの統合
- [x] 4.1 remoteページへScriptAutoSenderPanelを追加する
  - 既存のScriptPanelと並べて表示する
  - 親コンポーネントのhandleScriptSendとisScriptSendingを渡す
  - 開始後（hasStarted）のみ表示する既存パターンに従う
  - 手動送信（ScriptPanel）と自動送信が独立して動作することを確認する
  - _Requirements: 5.1, 5.2, 5.4_

- [x] 5. テストの実装
- [x] 5.1 (P) パース機能のユニットテストを作成する
  - 正常なJSONファイルのパース成功を確認する
  - scriptsプロパティがない場合のエラーを確認する
  - 空のscripts配列の場合のエラーを確認する
  - 個別台本のバリデーションエラーを確認する
  - defaultIntervalの有無による動作の違いを確認する
  - _Requirements: 1.2, 1.3_

- [x] 5.2 Hookの状態遷移テストを作成する
  - idle→running→paused→running→completed の遷移を確認する
  - stop()でidleに戻りインデックスがリセットされることを確認する
  - pause中にresume()で正しいインデックスから再開することを確認する
  - setIntervalで間隔が変更されることを確認する
  - _Requirements: 2.1, 2.2, 3.1, 3.2, 3.3, 4.3, 4.4_

- [x] 5.3 送信ループのインテグレーションテストを作成する
  - モックonScriptSendで全台本が順次送信されることを確認する
  - isSendingがtrueの間は次の送信が待機されることを確認する
  - 設定した間隔分の待機が行われることを確認する
  - 一時停止・再開時のタイミングが正しいことを確認する
  - _Requirements: 2.2, 5.1, 5.2_

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1.1 | 3.1 |
| 1.2 | 1.1, 1.2, 2.1, 5.1 |
| 1.3 | 1.2, 2.1, 3.1, 5.1 |
| 1.4 | 3.2 |
| 2.1 | 2.2, 3.3, 5.2 |
| 2.2 | 2.2, 5.2, 5.3 |
| 2.3 | 3.2 |
| 2.4 | 2.2, 3.2 |
| 3.1 | 2.3, 3.3, 5.2 |
| 3.2 | 2.3, 3.3, 5.2 |
| 3.3 | 2.2, 3.3, 5.2 |
| 3.4 | 3.3 |
| 4.1 | 3.4 |
| 4.2 | 2.1 |
| 4.3 | 2.4, 5.2 |
| 4.4 | 2.4, 5.2 |
| 5.1 | 2.2, 4.1, 5.3 |
| 5.2 | 2.2, 4.1, 5.3 |
| 5.3 | 3.1, 3.2, 3.3, 3.4 |
| 5.4 | 4.1 |
