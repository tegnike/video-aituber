# Implementation Plan

## Tasks

- [x] 1. 共有状態管理の基盤を構築
- [x] 1.1 サーバーサイドの共有状態ストアを作成
  - アプリケーション全体の状態を保持するインメモリストアを構築
  - 配信開始状態、画面モード、コントロール動画状態、わんコメ連携状態、UI表示設定を管理
  - 状態変更時に購読者へ通知する仕組みを用意
  - _Requirements: 2.5, 3.3, 4.1, 4.2, 4.3_

- [x] 1.2 (P) 状態取得・更新APIを作成
  - メイン画面から現在の状態を報告するエンドポイントを構築
  - 状態を取得するエンドポイントを構築
  - 不正なリクエストに対するバリデーションとエラーハンドリング
  - _Requirements: 2.5, 4.2, 4.3_

- [x] 1.3 (P) コマンド受信APIを作成
  - リモートパネルからの操作コマンドを受け付けるエンドポイントを構築
  - 画面モード選択、開始/終了動画、台本送信、わんコメ切替、UI表示切替のコマンドを処理
  - コマンドタイプごとのバリデーション
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 3.2, 5.1, 5.2, 5.3_

- [x] 2. リアルタイム通信の実装
- [x] 2.1 SSEエンドポイントを作成
  - Server-Sent Eventsで状態変更をリアルタイムにプッシュ
  - クライアント接続の管理（登録・解除）
  - 状態変更イベントと受信コマンドイベントの配信
  - _Requirements: 2.5, 3.3, 4.1_

- [x] 2.2 SSE接続管理フックを作成
  - クライアント側でSSE接続を確立・維持するカスタムフック
  - 接続状態の管理（接続中/切断/エラー）
  - 自動再接続ロジック（切断時に3秒後リトライ、最大5回）
  - コマンド送信機能の統合
  - _Requirements: 4.1, 4.4_

- [x] 3. リモート操作パネルUIの構築
- [x] 3.1 リモート操作ページの骨格を作成
  - リモート操作専用ページを新規作成
  - SSE接続を使用した状態購読
  - 接続待機中・接続済み・エラー時の表示切替
  - _Requirements: 1.1_

- [x] 3.2 (P) 画面モード選択UIを作成
  - メイン画面が未開始時にモード選択ボタンを表示
  - 待機画面/初期画面の選択機能
  - 選択時にコマンドAPIを呼び出し
  - 開始済み時は現在のモードを表示
  - _Requirements: 3.1, 3.2, 3.3_

- [x] 3.3 (P) コントロールボタンを作成
  - 開始/終了ボタンの表示
  - ボタン押下時にコマンドAPIを呼び出し
  - ローディング中・再生中は操作を無効化
  - _Requirements: 1.2, 2.1, 2.2_

- [x] 3.4 (P) 状態表示コンポーネントを作成
  - 接続状態インジケーター（接続中/切断）
  - 現在の画面モード表示
  - ローディング状態表示
  - 再生中のコントロール動画アクション名表示
  - _Requirements: 2.5, 3.3, 4.1, 4.2, 4.3_

- [x] 3.5 (P) わんコメ連携切替ボタンを作成
  - ON/OFF切替ボタンの表示
  - 現在の接続状態表示（接続中/エラー）
  - 切替時にコマンドAPIを呼び出し
  - _Requirements: 1.4, 2.4_

- [x] 3.6 台本パネルをリモートページに統合
  - 既存のScriptPanelコンポーネントを再利用
  - 台本送信時にコマンドAPI経由でメイン画面に反映
  - _Requirements: 1.3, 2.3_

- [x] 4. メイン画面の拡張
- [x] 4.1 メイン画面にSSE購読を追加
  - SSE経由でリモートからのコマンドを受信
  - 受信したコマンドに応じて状態を更新
  - 状態変更時に状態報告APIを呼び出し
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 3.2_

- [x] 4.2 UI表示オプションを追加
  - コントロールボタン・台本パネルの表示/非表示切替
  - チャット履歴の表示/非表示切替
  - チャット入力欄の表示/非表示切替
  - リモートからの切替コマンドに応答
  - _Requirements: 5.1, 5.2, 5.3_

- [x] 5. 統合とテスト
- [x] 5.1 リモート操作フローの統合テスト
  - リモートパネルから開始/終了ボタン操作→メイン画面で動画再生
  - 台本送信→動画生成→再生の一連フロー
  - わんコメ連携のON/OFF切替
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [x] 5.2 状態同期の検証
  - SSE接続断→自動再接続の動作確認
  - メイン画面の状態変更がリモートパネルに反映されることを確認
  - UI表示切替がメイン画面に反映されることを確認
  - _Requirements: 3.3, 4.1, 4.4, 5.1, 5.2, 5.3_
